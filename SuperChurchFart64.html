<html>
<head>
<title>Super Church Fart 64</title>
<style type="text/css">
    #gameDiv
    {
        user-select: none;
        background-color:#7f7f7f;
        width: 768px;
        height: 576px;
    }
</style>
</head>
<body onload="init()">
<h1>Super Church Fart 64</h1>
<h2>Ludum Dare 25</h2>
<h3 id="descriptionHeader"></h3>
<div id="gameDiv">
    <canvas id="gameCanvas"
            width="768"
            height="576"></canvas>
</div>
<form>
    <select id="levelSelect" onchange="onLevelSelectChanged(this)">
    </select>
</form>
<div id="soundDiv">
    <audio id="musicSound" controls preload="auto" autobuffer autoplay="autoplay" loop>
        <source src="sounds/Just_Fartin'_Around.mp3" />
        <source src="sounds/Just_Fartin'_Around.ogg" />
    </audio>
    <audio id="fartSound" preload="auto" autobuffer>
        <source src="sounds/fart.mp3"/>
        <source src="sounds/fart.ogg"/>
    </audio>
</div>
<script src="js/easeljs-0.5.0.min.js" type="text/javascript"></script>
<script src="js/SoundJS.js" type="text/javascript"></script>
<script src="js/HTMLAudioPlugin.js" type="text/javascript"></script>
<script src="js/swfobject.js" type="text/javascript"></script>
<script src="js/FlashPlugin.js" type="text/javascript"></script>
<script src="js/Globals.js" type="text/javascript"></script>
<script src="js/Levels.js" type="text/javascript"></script>
<script src="js/Entity.js" type="text/javascript"></script>
<script src="js/CollidableEntity.js" type="text/javascript"></script>
<script src="js/Content.js" type="text/javascript"></script>
<script src="js/Player.js" type="text/javascript"></script>
<script src="js/NPC.js" type="text/javascript"></script>
<script src="js/Fart.js" type="text/javascript"></script>
<script src="js/Fan.js" type="text/javascript"></script>
<script src="js/Map.js" type="text/javascript"></script>
<script>
    // add levels to the level selector
    var levelSelect = document.getElementById("levelSelect");

    var descriptionHeader = document.getElementById("descriptionHeader");
    var fartSound = document.getElementById("fartSound");
    for (var i in Levels)
    {
        levelSelect.add(new Option(i, i), null);
    }

    var gameController =
    {
        canvas: null,
        stage: null,
        currentMap: null,
		objectsToDelete: [],
		currentLevelIndex: 0
    };
	
	gameController.loadNextLevel = function() {
        levelSelect.selectedIndex = levelSelect.selectedIndex + 1;
        onLevelSelectChanged(levelSelect);
	};
	
	gameController.reloadLevel = function() {
		this.loadLevelByIndex(levelSelect.selectedIndex);
	};
	
	gameController.loadLevelByIndex = function(index) {
        var count = 0;
        var name = null;
        for (var levelName in Levels)
        {
            if (count == index)
            {
                name = levelName
            }
            count++;
        }
        if (name != null)
        {
            this.loadLevelByName(name);
        }
    };
	gameController.loadLevelByName = function(name)
    {
        var level = Levels[name];
        this.loadLevel(level, name);
	};
    
    gameController.loadLevel = function(level, name)
    {
        this.currentMap = new Map(name, this.stage, level.map);
		descriptionHeader.innerHTML = level.description;
        // Reset everything for the new map.
        this.stage.removeAllChildren();
        this.currentMap.parseRows();
        this.objectsToDelete = [];
 
        // Reset player fart count
        player.fartsRemaining = 10;
    };
    
    function getDistanceEntities() {
        return gameController.currentMap.distanceEntities;
    };
    
    function getEntityList(newTileX, newTileY) {
        return gameController.currentMap.getEntityList(newTileX, newTileY);
    };
    
	function addEntity(newEntity) {
		gameController.currentMap.addEntity(newEntity);
	};
	
	function removeEntity(newEntity)
    {
		gameController.objectsToDelete.push(newEntity);
	};
    
    function removeEntityFromMap(newEntity)
    {
        gameController.currentMap.removeEntity(newEntity);
    };

    function onLevelSelectChanged(select)
    {
        var selectedIndex = select.selectedIndex;
        var selectedValue = select.options[selectedIndex].value;
        gameController.loadLevelByName(selectedValue);
    }

    gameController.init = function()
    {
        this.canvas = document.getElementById("gameCanvas");
        this.stage = new createjs.Stage(this.canvas);

        this.loadLevelByIndex(0);
    };

    gameController.tick = function()
    {
        for(var i = 0; i < this.stage.children.length; i++) {
			if (this.stage.children[i].tick) {
				this.stage.children[i].tick();
			}
		}
		this.stage.update();
		
		for(var i = this.objectsToDelete.length - 1; i >= 0; i--) {
			this.stage.removeChild(this.objectsToDelete[i]);
            this.currentMap.removeEntity(this.objectsToDelete[i]);
		}
		
		this.objectsToDelete = [];
    };

    function init()
    {
        gameController.init();

        addEntity(new NPC(2, 2, Content.getSpriteSheet("HeatherTall.png"), { startX: 2 * TileWidth, startY: 2 * TileHeight, endX: 16 * TileWidth, endY: 2 * TileHeight, pauseTime: 1000.0, moveTime: 400.0 }));
        addEntity(new NPC(2, 3, Content.getSpriteSheet("M_Short_Grandpa.png"), { startX: 2 * TileWidth, startY: 3 * TileHeight, endX: 2 * TileWidth, endY: 5 * TileHeight, pauseTime: 500.0, moveTime: 1000.0 }));
        addEntity(new NPC(4, 7, Content.getSpriteSheet("FlowerGirlToo.png"), { startX: 3 * TileWidth, startY: 7 * TileHeight, endX: 8 * TileWidth, endY: 7 * TileHeight, pauseTime: 0.0, moveTime: 10.0 }));

        // start game timer
        createjs.Ticker.addListener(gameController);
        createjs.Ticker.setFPS(60);

        gameController.stage.update();
    };
</script>
</body>
</html>
